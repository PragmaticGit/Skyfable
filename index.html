<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyFable - Weather-Based Game Discovery</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="games-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Quicksand', sans-serif; 
            margin: 0; 
        }
        .pulse-animation {
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        .loading-spin {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        const SkyFable = () => {
          const [currentScreen, setCurrentScreen] = useState('landing');
          const [weather, setWeather] = useState(null);
          const [location, setLocation] = useState(null);
          const [gameRecommendation, setGameRecommendation] = useState(null);
          const [loadingProgress, setLoadingProgress] = useState(0);
          const [lastGameTitle, setLastGameTitle] = useState(null);
          const [locationError, setLocationError] = useState(false);

          // Game database is now loaded from external file
          // Available as window.gameDatabase

          const getWeatherType = (condition, temp = 20) => {
            const lowerCondition = condition.toLowerCase();
            console.log('Weather condition received:', condition, 'Temperature:', temp);
            
            let weatherType = 'clear';
            
            if (lowerCondition.includes('rain') || lowerCondition.includes('drizzle') || 
                lowerCondition.includes('shower') || lowerCondition.includes('storm')) {
              weatherType = 'rain';
            } else if (lowerCondition.includes('snow') || lowerCondition.includes('blizzard')) {
              weatherType = 'snow';
            } else if (lowerCondition.includes('cloud') || lowerCondition.includes('overcast')) {
              weatherType = 'cloudy';
            } else if (lowerCondition.includes('sun') || lowerCondition.includes('clear') || (temp > 25)) {
              weatherType = 'sunny';
            } else if (lowerCondition.includes('fog') || lowerCondition.includes('mist')) {
              weatherType = 'cloudy';
            }
            
            console.log('Determined weather type:', weatherType);
            return weatherType;
          };

          const selectRandomGame = (weatherType, avoidTitle = null) => {
            const availableGames = window.gameDatabase[weatherType] || window.gameDatabase.clear;
            console.log('Available games for', weatherType, ':', availableGames.map(g => g.title));
            
            if (availableGames.length <= 1 || !avoidTitle) {
              const randomGame = availableGames[Math.floor(Math.random() * availableGames.length)];
              console.log('Selected game:', randomGame.title);
              return randomGame;
            }
            
            const filteredGames = availableGames.filter(game => game.title !== avoidTitle);
            const gamesToChooseFrom = filteredGames.length > 0 ? filteredGames : availableGames;
            
            const randomGame = gamesToChooseFrom[Math.floor(Math.random() * gamesToChooseFrom.length)];
            console.log('Selected game (avoiding duplicates):', randomGame.title);
            return randomGame;
          };

          const fetchWeather = async (lat, lon) => {
            try {
              const response = await fetch(`https://wttr.in/${lat},${lon}?format=j1`);
              
              if (!response.ok) {
                throw new Error('Weather fetch failed');
              }
              
              const data = await response.json();
              const current = data.current_condition[0];
              const location = data.nearest_area[0];
              
              return {
                weather: [{ 
                  main: current.weatherDesc[0].value,
                  description: current.weatherDesc[0].value.toLowerCase()
                }],
                name: location.areaName[0].value,
                main: { 
                  temp: parseInt(current.temp_C)
                }
              };
            } catch (error) {
              console.error('Weather API failed, using fallback:', error);
              return {
                weather: [{ main: 'Rain', description: 'rainy evening' }],
                name: 'Stavanger',
                main: { temp: 18 }
              };
            }
          };

          const getLocation = () => {
            return new Promise((resolve, reject) => {
              if (!navigator.geolocation) {
                console.log('Geolocation not supported, using fallback');
                resolve({ lat: 59.9139, lon: 10.7522 });
                return;
              }

              navigator.geolocation.getCurrentPosition(
                (position) => {
                  console.log('Location permission granted');
                  setLocationError(false);
                  resolve({
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                  });
                },
                (error) => {
                  console.error('Geolocation error:', error);
                  if (error.code === error.PERMISSION_DENIED) {
                    console.log('Location permission denied by user');
                    setLocationError(true);
                    reject(new Error('Location permission denied'));
                  } else {
                    console.log('Location error, using fallback');
                    resolve({ lat: 59.9139, lon: 10.7522 });
                  }
                }
              );
            });
          };

          const handleForecastClick = async () => {
            setCurrentScreen('loading');
            setLoadingProgress(0);
            setLocationError(false);

            const progressInterval = setInterval(() => {
              setLoadingProgress(prev => {
                if (prev >= 90) {
                  clearInterval(progressInterval);
                  return 90;
                }
                return prev + Math.random() * 25;
              });
            }, 150);

            try {
              const userLocation = await getLocation();
              setLocation(userLocation);

              const weatherData = await fetchWeather(userLocation.lat, userLocation.lon);
              setWeather(weatherData);
              console.log('=== WEATHER DATA ===');
              console.log('Raw weather:', weatherData);

              const weatherType = getWeatherType(weatherData.weather[0].main, weatherData.main.temp);
              console.log('=== GAME SELECTION ===');
              const randomGame = selectRandomGame(weatherType);
              console.log('Final selected game:', randomGame);
              
              setGameRecommendation(randomGame);
              setLastGameTitle(randomGame.title);

              setTimeout(() => {
                setLoadingProgress(100);
                setTimeout(() => {
                  setCurrentScreen('result');
                }, 300);
              }, 1200);

            } catch (error) {
              console.error('Error fetching data:', error);
              clearInterval(progressInterval);
              
              if (error.message === 'Location permission denied') {
                setTimeout(() => {
                  setCurrentScreen('location-error');
                }, 1000);
              } else {
                const allWeatherTypes = ['rain', 'sunny', 'cloudy', 'snow', 'clear'];
                const randomWeatherType = allWeatherTypes[Math.floor(Math.random() * allWeatherTypes.length)];
                console.log('Using fallback weather type:', randomWeatherType);
                
                const fallbackGame = selectRandomGame(randomWeatherType);
                setGameRecommendation(fallbackGame);
                setLastGameTitle(fallbackGame.title);
                
                setWeather({
                  weather: [{ main: 'Unknown', description: 'weather unavailable' }],
                  name: 'Your Location',
                  main: { temp: 20 }
                });
                
                setTimeout(() => {
                  setLoadingProgress(100);
                  setTimeout(() => {
                    setCurrentScreen('result');
                  }, 300);
                }, 1200);
              }
            }
          };

          const handleRollAgain = () => {
            setCurrentScreen('loading');
            setLoadingProgress(0);

            const progressInterval = setInterval(() => {
              setLoadingProgress(prev => {
                if (prev >= 90) {
                  clearInterval(progressInterval);
                  return 90;
                }
                return prev + Math.random() * 20;
              });
            }, 200);

            setTimeout(() => {
              if (weather) {
                const weatherType = getWeatherType(weather.weather[0].main, weather.main.temp);
                const randomGame = selectRandomGame(weatherType, lastGameTitle);
                setGameRecommendation(randomGame);
                setLastGameTitle(randomGame.title);
              }
              
              setLoadingProgress(100);
              setTimeout(() => {
                setCurrentScreen('result');
              }, 300);
            }, 1200);
          };

          useEffect(() => {
            const loadInitialWeather = async () => {
              try {
                const userLocation = await getLocation();
                setLocation(userLocation);
                const weatherData = await fetchWeather(userLocation.lat, userLocation.lon);
                setWeather(weatherData);
              } catch (error) {
                console.error('Failed to load initial weather:', error);
              }
            };

            loadInitialWeather();
          }, []);

          const renderLanding = () => (
            <div className="min-h-screen relative overflow-hidden" style={{backgroundColor: '#837EB4'}}>
              <nav className="flex justify-between items-center px-8 py-6 relative z-10" style={{backgroundColor: '#504B81'}}>
                <div 
                  className="text-white text-2xl font-bold cursor-pointer hover:opacity-80 transition-opacity"
                  onClick={() => setCurrentScreen('landing')}
                >
                  Sky<span style={{color: '#FFF099'}}>Fable</span>
                </div>
                <button 
                  onClick={handleForecastClick}
                  className="px-6 py-3 border-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105"
                  style={{
                    borderColor: '#FFF099',
                    color: '#FFF099',
                    backgroundColor: 'transparent'
                  }}
                  onMouseEnter={(e) => {
                    e.target.style.backgroundColor = '#FFF099';
                    e.target.style.color = '#504B81';
                  }}
                  onMouseLeave={(e) => {
                    e.target.style.backgroundColor = 'transparent';
                    e.target.style.color = '#FFF099';
                  }}
                >
                  Forecast My Game
                </button>
              </nav>

              <div className="flex items-center justify-center min-h-[calc(100vh-120px)] px-8">
                <div className="flex items-center justify-between max-w-7xl w-full">
                  <div className="flex-1 pr-16">
                    <h1 className="text-5xl md:text-6xl font-bold mb-6 leading-tight" style={{color: '#FFF099'}}>
                      Find the perfect game based on your local weather
                    </h1>
                    
                    <p className="text-xl mb-8 text-white opacity-90 font-medium leading-relaxed">
                      Right now in <span className="font-bold">{weather?.name || 'Stavanger'}</span>, It's a{' '}
                      <span className="font-bold" style={{color: '#FFF099'}}>
                        {weather ? weather.weather[0].description : 'rainy evening'}
                      </span>{' '}
                      so it's time for something quiet and reflective 🌧️
                    </p>

                    <button 
                      onClick={handleForecastClick}
                      className="px-8 py-4 rounded-lg font-bold text-lg transition-all duration-300 hover:scale-105 shadow-lg"
                      style={{
                        backgroundColor: '#FFF099',
                        color: '#504B81'
                      }}
                    >
                      Forecast My Game
                    </button>
                  </div>

                  <div className="flex-1 flex justify-center">
                    <img 
                      src="https://raw.githubusercontent.com/PragmaticGit/Skyfable/main/images/hero-image.png" 
                      alt="Gaming illustration" 
                      className="max-w-full h-auto"
                      style={{
                        maxHeight: '400px',
                        width: 'auto',
                        display: 'block'
                      }}
                      onError={(e) => {
                        console.log('GitHub raw URL failed, trying relative path...');
                        e.target.src = "./images/hero-image.png";
                        e.target.onerror = () => {
                          console.log('All paths failed for hero image');
                          e.target.style.display = 'none';
                          e.target.parentNode.innerHTML = '<div style="width: 400px; height: 300px; background: rgba(255,255,255,0.1); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">🎮 Gaming Illustration</div>';
                        };
                      }}
                    />
                  </div>
                </div>
              </div>
            </div>
          );

          const renderLoading = () => (
            <div className="min-h-screen relative flex flex-col" style={{backgroundColor: '#837EB4'}}>
              <nav className="flex justify-between items-center px-8 py-6" style={{backgroundColor: '#504B81'}}>
                <div 
                  className="text-white text-2xl font-bold cursor-pointer hover:opacity-80 transition-opacity"
                  onClick={() => setCurrentScreen('landing')}
                >
                  Sky<span style={{color: '#FFF099'}}>Fable</span>
                </div>
                <button 
                  className="px-6 py-3 border-2 rounded-lg font-semibold opacity-50 cursor-not-allowed"
                  style={{
                    borderColor: '#FFF099',
                    color: '#FFF099'
                  }}
                >
                  Forecast My Game
                </button>
              </nav>

              <div className="flex-1 flex flex-col items-center justify-center px-8">
                <h1 className="text-5xl md:text-6xl font-bold mb-8 text-white text-center">
                  Sky<span style={{color: '#FFF099'}}>Fable</span>
                </h1>
                
                <p className="text-2xl mb-16 text-center font-medium pulse-animation" style={{color: '#FFF099'}}>
                  Contacting the nearest cloud spirit and<br />
                  matching you with the perfect game...
                </p>

                <div className="mb-8">
                  <img 
                    src="https://raw.githubusercontent.com/PragmaticGit/Skyfable/main/images/loading-gif.png" 
                    alt="Loading animation" 
                    className="w-24 h-24 loading-spin"
                    onError={(e) => {
                      console.log('Loading gif failed, trying relative path...');
                      e.target.src = "./images/loading-gif.png";
                    }}
                  />
                </div>
              </div>
            </div>
          );

          const renderResult = () => (
            <div className="min-h-screen relative overflow-hidden" style={{backgroundColor: '#837EB4'}}>
              <nav className="flex justify-between items-center px-8 py-6 relative z-10" style={{backgroundColor: '#504B81'}}>
                <div 
                  className="text-white text-2xl font-bold cursor-pointer hover:opacity-80 transition-opacity"
                  onClick={() => setCurrentScreen('landing')}
                >
                  Sky<span style={{color: '#FFF099'}}>Fable</span>
                </div>
                <button 
                  onClick={() => setCurrentScreen('landing')}
                  className="px-6 py-3 border-2 rounded-lg font-semibold transition-all duration-300"
                  style={{
                    borderColor: '#FFF099',
                    color: '#FFF099'
                  }}
                >
                  Forecast My Game
                </button>
              </nav>

              <div className="flex items-center justify-center min-h-[calc(100vh-120px)] px-8">
                <div className="flex items-center justify-between max-w-7xl w-full">
                  <div className="flex-shrink-0 mr-16">
                    <div className="w-80 h-72 rounded-lg shadow-2xl overflow-hidden relative bg-gray-900">
                      <img 
                        src={gameRecommendation?.gameImage || "https://cdn.akamai.steamstatic.com/steam/apps/383870/header.jpg"}
                        alt={gameRecommendation?.title || "Game cover"}
                        className="w-full h-full object-cover rounded-lg"
                        style={{objectPosition: 'center top'}}
                        onError={(e) => {
                          console.log('Game image failed to load:', e.target.src);
                          e.target.style.display = 'none';
                          e.target.parentNode.style.background = 'linear-gradient(135deg, #F59E0B 0%, #D97706 50%, #B45309 100%)';
                          e.target.parentNode.innerHTML = `
                            <div class="absolute inset-0 flex flex-col items-center justify-center text-center p-8">
                              <div class="text-7xl mb-6">🎮</div>
                              <h3 class="text-2xl font-bold text-white mb-4 tracking-wide">
                                ${(gameRecommendation?.title || 'GAME').toUpperCase()}
                              </h3>
                              <div class="text-orange-100 font-medium text-sm leading-relaxed">
                                Image unavailable
                              </div>
                            </div>
                          `;
                        }}
                        onLoad={(e) => {
                          console.log('Game image loaded successfully:', gameRecommendation?.title);
                        }}
                      />
                    </div>
                  </div>

                  <div className="flex-1">
                    <div className="flex flex-wrap gap-3 mb-6">
                      {(gameRecommendation?.tags || ['Single-player', 'Atmospheric', 'Story-Rich']).map((tag, index) => (
                        <span 
                          key={index}
                          className="px-4 py-2 rounded-full text-sm font-semibold"
                          style={{
                            backgroundColor: '#FFF8CC',
                            color: '#504B81'
                          }}
                        >
                          {tag}
                        </span>
                      ))}
                    </div>

                    <h2 className="text-5xl md:text-6xl font-bold mb-6" style={{color: '#FFF099'}}>
                      {gameRecommendation?.title || 'Firewatch'}
                    </h2>

                    <p className="text-white text-lg leading-relaxed mb-8 opacity-90 font-medium">
                      {gameRecommendation?.description || "Today's drizzle sets the mood for something quiet and reflective. Firewatch is a first-person mystery in the Wyoming wilderness, where your only lifeline is a voice on the other end of a radio."}
                    </p>

                    <div className="flex gap-4">
                      <button 
                        onClick={() => window.open(gameRecommendation?.steamUrl || "https://store.steampowered.com/app/383870/Firewatch/", '_blank')}
                        className="px-8 py-3 rounded-lg font-bold transition-all duration-300 hover:scale-105 shadow-lg"
                        style={{
                          backgroundColor: '#FFF099',
                          color: '#504B81'
                        }}
                      >
                        View On Steam
                      </button>
                      <button 
                        onClick={handleRollAgain}
                        className="px-8 py-3 border-2 rounded-lg font-bold transition-all duration-300"
                        style={{
                          borderColor: '#FFF8CC',
                          color: '#FFF8CC',
                          backgroundColor: 'transparent'
                        }}
                        onMouseEnter={(e) => {
                          e.target.style.backgroundColor = '#FFF8CC';
                          e.target.style.color = '#504B81';
                        }}
                        onMouseLeave={(e) => {
                          e.target.style.backgroundColor = 'transparent';
                          e.target.style.color = '#FFF8CC';
                        }}
                      >
                        Roll Again
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );

          const renderLocationError = () => (
            <div className="min-h-screen relative flex flex-col" style={{backgroundColor: '#837EB4'}}>
              <nav className="flex justify-between items-center px-8 py-6" style={{backgroundColor: '#504B81'}}>
                <div 
                  className="text-white text-2xl font-bold cursor-pointer hover:opacity-80 transition-opacity"
                  onClick={() => setCurrentScreen('landing')}
                >
                  Sky<span style={{color: '#FFF099'}}>Fable</span>
                </div>
                <button 
                  onClick={() => setCurrentScreen('landing')}
                  className="px-6 py-3 border-2 rounded-lg font-semibold transition-all duration-300"
                  style={{
                    borderColor: '#FFF099',
                    color: '#FFF099'
                  }}
                >
                  Back to Home
                </button>
              </nav>

              <div className="flex-1 flex flex-col items-center justify-center px-8">
                <div className="text-center max-w-md">
                  <div className="text-6xl mb-6">📍</div>
                  <h1 className="text-4xl font-bold text-white mb-6">
                    Location Needed
                  </h1>
                  
                  <p className="text-lg mb-8 text-white opacity-90 font-medium leading-relaxed">
                    SkyFable needs your location to check the weather and find the perfect game for you. 
                    Please enable location permissions and try again.
                  </p>

                  <div className="space-y-4">
                    <button 
                      onClick={handleForecastClick}
                      className="w-full px-8 py-3 rounded-lg font-bold transition-all duration-300 hover:scale-105 shadow-lg"
                      style={{
                        backgroundColor: '#FFF099',
                        color: '#504B81'
                      }}
                    >
                      Try Again
                    </button>
                    
                    <button 
                      onClick={() => setCurrentScreen('landing')}
                      className="w-full px-8 py-3 border-2 rounded-lg font-bold transition-all duration-300"
                      style={{
                        borderColor: '#FFF8CC',
                        color: '#FFF8CC',
                        backgroundColor: 'transparent'
                      }}
                    >
                      Back to Home
                    </button>
                  </div>

                  <p className="text-sm text-white opacity-60 mt-6">
                    💡 Tip: Look for the location icon in your browser's address bar
                  </p>
                </div>
              </div>
            </div>
          );

          switch (currentScreen) {
            case 'loading':
              return renderLoading();
            case 'result':
              return renderResult();
            case 'location-error':
              return renderLocationError();
            default:
              return renderLanding();
          }
        };

        ReactDOM.render(React.createElement(SkyFable), document.getElementById('root'));
    </script>
</body>
</html>
