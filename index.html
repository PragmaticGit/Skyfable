<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyFable - Weather-Based Game Discovery</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="games-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Quicksand', sans-serif; margin: 0; }
        .pulse-animation { animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
        .loading-spin { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .bg-primary { background-color: #837EB4; }
        .bg-secondary { background-color: #504B81; }
        .text-accent { color: #FFF099; }
        .border-accent { border-color: #FFF099; }
        .bg-accent { background-color: #FFF099; }
        .text-secondary { color: #504B81; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        const SkyFable = () => {
          const [screen, setScreen] = useState('landing');
          const [weather, setWeather] = useState(null);
          const [game, setGame] = useState(null);
          const [showWeatherSelect, setShowWeatherSelect] = useState(false);

          const handleManualWeather = (type) => {
            const g = selectGame(type);
            setGame(g);
            setLastGame(g.title);
            setShowWeatherSelect(false);
            setScreen('result');
          };

          const getWeatherType = (condition, temp = 20) => {
            const c = condition.toLowerCase();
            if (c.match(/rain|drizzle|shower|storm/)) return 'rain';
            if (c.match(/snow|blizzard/)) return 'snow';
            if (c.match(/cloud|overcast|fog|mist/)) return 'cloudy';
            if (c.match(/sun|clear/) || temp > 25) return 'sunny';
            return 'clear';
          };

          const selectGame = (type, avoid = null) => {
            const games = window.gameDatabase[type] || window.gameDatabase.clear;
            const filtered = avoid ? games.filter(g => g.title !== avoid) : games;
            const pool = filtered.length ? filtered : games;
            return pool[Math.floor(Math.random() * pool.length)];
          };

          const fetchWeather = async (lat, lon) => {
            try {
              // Try OpenWeatherMap first (more reliable)
              const owmKey = ''; // You'll need to add your API key
              if (owmKey) {
                const owmRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${owmKey}&units=metric`);
                if (owmRes.ok) {
                  const data = await owmRes.json();
                  return {
                    weather: [{ 
                      main: data.weather[0].main,
                      description: data.weather[0].description
                    }],
                    name: data.name,
                    main: { temp: Math.round(data.main.temp) }
                  };
                }
              }
              
              // Fallback to wttr.in with explicit city name for Stavanger area
              const isStavangerArea = Math.abs(lat - 58.97) < 0.3 && Math.abs(lon - 5.73) < 0.3;
              const query = isStavangerArea ? 'Stavanger,Norway' : `${lat.toFixed(4)},${lon.toFixed(4)}`;
              
              const res = await fetch(`https://wttr.in/${query}?format=j1`);
              const data = await res.json();
              const curr = data.current_condition[0];
              const loc = data.nearest_area[0];
              
              // Override location name if in Stavanger area
              const cityName = isStavangerArea ? 'Stavanger' : loc.areaName[0].value;
              
              return {
                weather: [{ 
                  main: curr.weatherDesc[0].value,
                  description: curr.weatherDesc[0].value.toLowerCase()
                }],
                name: cityName,
                main: { temp: parseInt(curr.temp_C) }
              };
            } catch (error) {
              console.error('Weather fetch error:', error);
              // More accurate fallback data
              return { 
                weather: [{ main: 'Cloudy', description: 'partly cloudy' }], 
                name: 'Stavanger', 
                main: { temp: 12 } 
              };
            }
          };

          const getLocation = () => new Promise((resolve, reject) => {
            if (!navigator.geolocation) return resolve({ lat: 58.9700, lon: 5.7331 });
            navigator.geolocation.getCurrentPosition(
              pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
              err => err.code === 1 ? reject(new Error('denied')) : resolve({ lat: 58.9700, lon: 5.7331 })
            );
          });

          const handleForecast = async () => {
            setScreen('loading');
            try {
              const loc = await getLocation();
              const w = await fetchWeather(loc.lat, loc.lon);
              setWeather(w);
              const type = getWeatherType(w.weather[0].main, w.main.temp);
              const g = selectGame(type);
              setGame(g);
              setLastGame(g.title);
              setTimeout(() => setScreen('result'), 1500);
            } catch (err) {
              if (err.message === 'denied') {
                setTimeout(() => setScreen('location-error'), 1000);
              } else {
                const types = ['rain', 'sunny', 'cloudy', 'snow', 'clear'];
                const g = selectGame(types[Math.floor(Math.random() * types.length)]);
                setGame(g);
                setLastGame(g.title);
                setWeather({ weather: [{ main: 'Unknown', description: 'weather unavailable' }], name: 'Your Location', main: { temp: 20 } });
                setTimeout(() => setScreen('result'), 1500);
              }
            }
          };

          const rollAgain = () => {
            setScreen('loading');
            setTimeout(() => {
              if (weather) {
                const type = getWeatherType(weather.weather[0].main, weather.main.temp);
                const g = selectGame(type, lastGame);
                setGame(g);
                setLastGame(g.title);
              }
              setScreen('result');
            }, 1200);
          };

          const handleManualWeather = (type) => {
            const g = selectGame(type);
            setGame(g);
            setLastGame(g.title);
            setShowWeatherSelect(false);
          };

          useEffect(() => {
            getLocation().then(loc => fetchWeather(loc.lat, loc.lon)).then(setWeather).catch(() => {});
          }, []);

          const Nav = ({ showButton = true }) => (
            <nav className="flex justify-between items-center px-4 sm:px-8 py-6 bg-secondary">
              <div className="text-white text-xl sm:text-2xl font-bold cursor-pointer hover:opacity-80" onClick={() => setScreen('landing')}>
                Sky<span className="text-accent">Fable</span>
              </div>
              {showButton && (
                <button onClick={handleForecast} className="px-4 sm:px-6 py-2 sm:py-3 border-2 border-accent text-accent rounded-lg font-semibold transition-all hover:scale-105 hover:bg-accent hover:text-secondary">
                  Forecast My Game
                </button>
              )}
            </nav>
          );

          const Button = ({ onClick, primary, children, className = "" }) => (
            <button
              onClick={onClick}
              className={`px-6 sm:px-8 py-3 rounded-lg font-bold transition-all ${className} ${
                primary 
                  ? 'bg-accent text-secondary hover:scale-105 shadow-lg' 
                  : 'border-2 border-accent text-accent hover:bg-accent hover:text-secondary'
              }`}
            >
              {children}
            </button>
          );

          const Landing = () => (
            <div className="min-h-screen bg-primary">
              <Nav />
              <div className="flex items-center justify-center min-h-[calc(100vh-120px)] px-4 sm:px-8">
                <div className="flex flex-col lg:flex-row items-center justify-between max-w-7xl w-full gap-8">
                  <div className="flex-1 text-center lg:text-left lg:pr-16">
                    <h1 className="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold mb-6 text-accent">
                      Find the perfect game based on your local weather
                    </h1>
                    <Button onClick={handleForecast} primary className="w-full sm:w-auto">
                      Forecast My Game
                    </Button>
                  </div>
                  <div className="flex-1 flex justify-center order-first lg:order-last">
                    <img 
                      src="https://raw.githubusercontent.com/PragmaticGit/Skyfable/main/images/hero-image.png" 
                      alt="Gaming" 
                      className="max-w-full h-auto"
                      style={{ maxHeight: '300px' }}
                      onError={(e) => {
                        e.target.style.display = 'none';
                        e.target.parentNode.innerHTML = '<div class="w-64 h-48 bg-white/10 rounded-2xl flex items-center justify-center text-white text-2xl">🎮 Gaming</div>';
                      }}
                    />
                  </div>
                </div>
              </div>
            </div>
          );

          const Loading = () => {
            const [message, setMessage] = useState(0);
            const messages = [
              "Contacting the nearest cloud spirit",
              "Reading atmospheric pressure patterns",
              "Consulting with weather wizards",
              "Matching you with the perfect game"
            ];
            
            useEffect(() => {
              const interval = setInterval(() => {
                setMessage(prev => (prev + 1) % messages.length);
              }, 2000);
              return () => clearInterval(interval);
            }, []);
            
            return (
              <div className="min-h-screen bg-primary flex flex-col">
                <Nav showButton={false} />
                <div className="flex-1 flex flex-col items-center justify-center px-8">
                  <h1 className="text-5xl md:text-6xl font-bold mb-8 text-white">
                    Sky<span className="text-accent">Fable</span>
                  </h1>
                  <p className="text-2xl mb-16 text-center font-medium text-accent pulse-animation">
                    {messages[message]}...
                  </p>
                  <img src="https://raw.githubusercontent.com/PragmaticGit/Skyfable/main/images/loading-gif.png" 
                       alt="Loading" className="w-24 h-24 loading-spin"
                       onError={(e) => e.target.style.display = 'none'} />
                </div>
              </div>
            );
          };

          const getWeatherEmoji = (type) => {
            const emojis = {
              rain: '🌧️',
              sunny: '☀️',
              cloudy: '☁️',
              snow: '❄️',
              clear: '✨'
            };
            return emojis[type] || '🌤️';
          };

          const Result = () => {
            const weatherType = weather ? getWeatherType(weather.weather[0].main, weather.main.temp) : 'clear';
            const weatherEmoji = getWeatherEmoji(weatherType);
            
            return (
              <div className="min-h-screen bg-primary">
                <Nav />
                <div className="flex items-center justify-center min-h-[calc(100vh-120px)] px-4 sm:px-8 py-8">
                  <div className="max-w-6xl w-full">
                    {/* Title Section */}
                    <div className="mb-8">
                      <h2 className="text-4xl sm:text-5xl lg:text-6xl font-bold text-accent mb-4">
                        {game?.title}
                      </h2>
                      <div className="flex flex-wrap gap-2">
                        {(game?.tags || []).map((tag, i) => (
                          <span key={i} className="px-3 py-1 rounded-full text-xs font-semibold bg-accent/20 text-accent">
                            {tag}
                          </span>
                        ))}
                      </div>
                    </div>
                    
                    {/* Main Content Grid */}
                    <div className="grid lg:grid-cols-3 gap-8 mb-8">
                      {/* Game Image - 2 columns */}
                      <div className="lg:col-span-2">
                        <div className="aspect-video rounded-lg shadow-2xl overflow-hidden bg-gray-900">
                          <img 
                            src={game?.gameImage}
                            alt={game?.title}
                            className="w-full h-full object-cover"
                            onError={(e) => {
                              e.target.style.display = 'none';
                              e.target.parentNode.innerHTML = `
                                <div class="h-full flex flex-col items-center justify-center bg-gradient-to-br from-orange-500 to-orange-700 text-white">
                                  <div class="text-7xl mb-4">🎮</div>
                                  <h3 class="text-3xl font-bold">${game?.title?.toUpperCase() || 'GAME'}</h3>
                                </div>`;
                            }}
                          />
                        </div>
                      </div>
                      
                      {/* Weather Box - 1 column */}
                      <div className="lg:col-span-1">
                        <div className="bg-white/10 rounded-lg p-6 backdrop-blur-sm h-full flex flex-col">
                          <div className="flex items-center gap-3 mb-4">
                            <span className="text-4xl">{weatherEmoji}</span>
                            <div>
                              <h3 className="text-xl font-bold text-accent">Perfect for {weatherType} weather</h3>
                              <p className="text-white/70 text-sm">{weather?.name || 'Your location'}</p>
                            </div>
                          </div>
                          <p className="text-white/90 text-sm leading-relaxed flex-grow">{game?.reasoning}</p>
                          <Button onClick={rollAgain} className="w-full mt-4">
                            Roll Again
                          </Button>
                          
                          {/* Manual weather selection */}
                          {showWeatherSelect ? (
                            <div className="mt-4 space-y-2">
                              <p className="text-xs text-white/70 mb-2">Select weather manually:</p>
                              <div className="grid grid-cols-2 gap-2">
                                <button onClick={() => handleManualWeather('sunny')} className="text-xs py-2 px-3 bg-white/10 rounded hover:bg-white/20 text-white">☀️ Sunny</button>
                                <button onClick={() => handleManualWeather('rain')} className="text-xs py-2 px-3 bg-white/10 rounded hover:bg-white/20 text-white">🌧️ Rain</button>
                                <button onClick={() => handleManualWeather('cloudy')} className="text-xs py-2 px-3 bg-white/10 rounded hover:bg-white/20 text-white">☁️ Cloudy</button>
                                <button onClick={() => handleManualWeather('snow')} className="text-xs py-2 px-3 bg-white/10 rounded hover:bg-white/20 text-white">❄️ Snow</button>
                              </div>
                            </div>
                          ) : (
                            <button 
                              onClick={() => setShowWeatherSelect(true)} 
                              className="text-xs text-white/50 hover:text-white/70 mt-4 underline"
                            >
                              Wrong weather?
                            </button>
                          )}
                          
                          {/* Manual weather selection */}
                          {showWeatherSelect ? (
                            <div className="mt-4 space-y-2">
                              <p className="text-xs text-white/70 mb-2">Select weather manually:</p>
                              <div className="grid grid-cols-2 gap-2">
                                <button onClick={() => handleManualWeather('sunny')} className="text-xs py-2 px-3 bg-white/10 rounded hover:bg-white/20 text-white">☀️ Sunny</button>
                                <button onClick={() => handleManualWeather('rain')} className="text-xs py-2 px-3 bg-white/10 rounded hover:bg-white/20 text-white">🌧️ Rain</button>
                                <button onClick={() => handleManualWeather('cloudy')} className="text-xs py-2 px-3 bg-white/10 rounded hover:bg-white/20 text-white">☁️ Cloudy</button>
                                <button onClick={() => handleManualWeather('snow')} className="text-xs py-2 px-3 bg-white/10 rounded hover:bg-white/20 text-white">❄️ Snow</button>
                              </div>
                            </div>
                          ) : (
                            <button 
                              onClick={() => setShowWeatherSelect(true)} 
                              className="text-xs text-white/50 hover:text-white/70 mt-4 underline"
                            >
                              Wrong weather?
                            </button>
                          )}
                        </div>
                      </div>
                    </div>
                    
                    {/* Description and Action Section */}
                    <div className="grid lg:grid-cols-3 gap-8">
                      <div className="lg:col-span-2">
                        <h3 className="text-xl font-bold text-white mb-3">About this game</h3>
                        <p className="text-white/90 text-base leading-relaxed mb-6">
                          {game?.description?.split('.')[0] + '.'}
                        </p>
                        <Button onClick={() => window.open(game?.steamUrl, '_blank')} primary className="w-full sm:w-auto">
                          View On Steam
                        </Button>
                      </div>
                      <div className="lg:col-span-1">
                        {/* Space for potential future features */}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          const LocationError = () => (
            <div className="min-h-screen bg-primary flex flex-col">
              <Nav showButton={false} />
              <div className="flex-1 flex items-center justify-center px-8">
                <div className="text-center max-w-md">
                  <div className="text-6xl mb-6">📍</div>
                  <h1 className="text-4xl font-bold text-white mb-6">Location Needed</h1>
                  <p className="text-lg mb-8 text-white opacity-90">
                    SkyFable needs your location to check the weather and find the perfect game for you.
                  </p>
                  <div className="space-y-4">
                    <Button onClick={handleForecast} primary className="w-full">Try Again</Button>
                    <Button onClick={() => setScreen('landing')} className="w-full">Back to Home</Button>
                  </div>
                  <p className="text-sm text-white opacity-60 mt-6">
                    💡 Tip: Look for the location icon in your browser's address bar
                  </p>
                </div>
              </div>
            </div>
          );

          const screens = { landing: Landing, loading: Loading, result: Result, 'location-error': LocationError };
          const Screen = screens[screen] || Landing;
          
          return <Screen />;
        };

        ReactDOM.render(<SkyFable />, document.getElementById('root'));
    </script>
</body>
</html>
